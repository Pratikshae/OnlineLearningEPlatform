<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prat's Coding Index Page</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
	crossorigin="anonymous" />

<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" th:href="@{/css/style.css}">

</head>
<body>
	<!-- Header starts-->
	<!-- importing header content from fragments/header.html file -->
	<!--  If user is active , so header will be imported from user-header.html. but if session is not active, it will import header.html -->
	<div th:if="${sessionUser == null OR sessionUser == ''}">
		<div th:replace="~{fragments/header :: header}"></div>
	</div>
	<div th:unless="${sessionUser == null OR sessionUser == ''}">
		<div th:replace="~{fragments/user-header  :: u-header}"></div>
	</div>

	<!-- Header ends-->

	<!-- Main Content starts-->
	<main>

		<!-- Banner-->
		<section class="container-fluid">
			<img src="/static/images/banner.jpg" alt="Prat Coding Banner" width="100%"
				height="25%" />
		</section>

		<!-- Content -->
		<section class="container py-4 bg-light">
			<h3 class="text-center mb-4">Our courses</h3>

			<!--courses div starts -->
			<div class="row g-4">
				<!--one course starts -->
				<div th:each="course: ${courseList}" class="col-lg-3 col-md-3 ">
					<div class="card h-100" style="width: 18rem">
						<img th:src="@{${course.imageURL}}"
							class="card-img-top img-fluid w-100 h-100 object-fit-cover"
							alt="Card image cap" />
						<div class="card-body d-flex flex-column">
							<h5 class="card-title">
								<span th:text="${course.courseName}"></span>
							</h5>
							<p class="card-text flex-grow-1">
								<span th:text="${course.description}"></span>>
							</p>
							<p>
								<strong> Price:</strong>
								<del>
									Rs. <span th:text="${course.originalPrice}"></span>
								</del>
								<span class="bg-light p-2">Rs. <span
									th:text="${course.discountedPrice}"></span></span>
							</p>
							<div th:if="${sessionUser == null OR sessionUser == ''}">
								<a class="btn btn-outline-primary" href="/login">Login to
									Buy</a>
							</div>
							<div th:unless="${sessionUser == null OR sessionUser == ''}">


								<div th:if="${purchasedCourseNameList != null and  #lists.contains(purchasedCourseNameList,course.courseName)}">
									<span class="text-success">Course already purchased</span>
								</div>
								<div th:unless="${purchasedCourseNameList != null and #lists.contains(purchasedCourseNameList,course.courseName)}">
									<button class="btn btn-primary"
										th:data-cname="${course.courseName}"
										th:data-camount="${course.discountedPrice}"
										th:data-uname="${sessionUser.name}"
										th:data-uemail="${sessionUser.email}"
										th:data-uphoneno="${sessionUser.phoneno}"
										onclick="purchaseCourse(this.getAttribute('data-cname'), this.getAttribute('data-camount'), this.getAttribute('data-uname'), this.getAttribute('data-uemail'), this.getAttribute('data-uphoneno'))">
										Buy</button>
								</div>
							</div>
						</div>
						<div class="card-footer text-muted">
							updated <span th:text="${course.updatedOn}"></span>
						</div>
					</div>
				</div>
				<!--one course end-->


				<!--course end-->
			</div>
			<!-- course div ends -->


		</section>
	</main>
	<!-- Main content ends-->

	<!--Footer starts-->
	<!-- importing footer content from fragments/footer.html -->
	<div th:replace="~{fragments/footer :: footer}"></div>
	<!--Footer ends-->

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
		crossorigin="anonymous"></script>

	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<!-- jquery cdn link for api integration -->

	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

	<script>
		function purchaseCourse(courseName, courseAmount, uName, uEmail,
				uPhoneno) {

			var options = {
				"key" : "rzp_test_R8IyBt7ELw4AGT",
				"amount" : courseAmount * 100,
				"currency" : "INR",
				"name" : "Prat's Coding",
				"description" : "Course Transaction",
				"image" : "https://images.sftcdn.net/images/t_app-icon-m/p/eac2174b-fc62-464c-9a83-14e16adccafe/2947989911/smart-programming-logo",
				"handler" : function(response) {
					console.log(response);
					alert("Payment successful");
					
					
					var date = new Date();
					var dateOfPurchase = date.toLocaleDateString('en-GB') + ", " + 
										 date.toLocaleTimeString('en-GB', { 
										 	hour12: true,
										 	hour: '2-digit',
										 	minute: '2-digit',
										 	second: '2-digit'
										 }).replace('am', 'AM').replace('pm','PM');
					//Data in JSON format
					var requestData = {

						courseName : courseName,
						courseAmount : courseAmount,
						userEmail : uEmail,
						dateOfPurcharse : dateOfPurchase,
						paymentId : response.razorpay_payment_id
					};
					//we are using AJAX, now.
					$
							.ajax({

								type : "POST",
								url : "/api/storeOderDetails",
								contentType : "application/json",

								// to convert any javascript datatype into string
								data : JSON.stringify(requestData),
								success : function(response) {
									console.log("Data stored successfully!!!");
									alert("Thank you for you purchase!"
											+ "You can now access your course from your dashboard.");

									window.location.href = "/myCourses";
								},

								error : function(error) {
									console.log("Error: " + error);
									alert("Something went wrong, try later."
											+ error);

								}

							});
				},
				"prefill" : {
					"name" : uName,
					"email" : uEmail,
					"contact" : uPhoneno
				},
				"notes" : {
					"courseName" : courseName
				},
				"theme" : {
					"color" : "#3399cc"
				}
			};
			var rzp1 = new Razorpay(options);
			rzp1.on('payment.failed', function(response) {
				console.log(response);
				alert("Error: " + response);
			});

			rzp1.open();
		}
	</script>
</body>
</html>
